<Window x:Class="MotorDebugStudio.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:scottplot="clr-namespace:ScottPlot.WPF;assembly=ScottPlot.WPF"
        xmlns:viewModels="clr-namespace:MotorDebugStudio.ViewModels"
        mc:Ignorable="d"
        Title="RXMCU_MotorMaster"
        Width="1680"
        Height="980"
        MinWidth="1280"
        MinHeight="760"
        Loaded="Window_Loaded"
        Closing="Window_Closing">
    <Window.DataContext>
        <viewModels:MainViewModel />
    </Window.DataContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="6" />
            <RowDefinition x:Name="BottomPanelRow" Height="220" MinHeight="120" />
        </Grid.RowDefinitions>

        <Menu Grid.Row="0">
            <MenuItem Header="File">
                <MenuItem Header="Import Variables From MAP..." Command="{Binding Param.BrowseAndImportMapCommand}" />
                <MenuItem Header="Refresh Addresses" Command="{Binding Param.RefreshAddressesCommand}" />
                <Separator />
                <MenuItem Header="Exit" Command="{x:Static ApplicationCommands.Close}" />
            </MenuItem>
            <MenuItem Header="Help">
                <MenuItem Header="Protocol: UART5 v1.0" IsEnabled="False" />
            </MenuItem>
        </Menu>

        <Border Grid.Row="1" Style="{StaticResource CardBorderStyle}" Margin="4,0,4,4" Padding="8,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBlock FontSize="16" FontWeight="SemiBold" Text="RX26T Motor Debug Studio" VerticalAlignment="Center" />

                <Border Grid.Column="1" Background="{Binding Connection.StateBrush}" CornerRadius="4" Padding="8,2" Margin="8,0">
                    <TextBlock Foreground="White" FontWeight="Bold" Text="{Binding Connection.StateLabel}" />
                </Border>

                <TextBlock Grid.Column="2"
                           Margin="8,0,0,0"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource BrushTextSecondary}"
                           Text="{Binding Scope.SampleRateHz, StringFormat=sampling: {0:F1} Hz}" />
            </Grid>
        </Border>

        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="LeftPaneColumn" Width="3*" MinWidth="360" />
                <ColumnDefinition Width="6" />
                <ColumnDefinition x:Name="CenterPaneColumn" Width="7*" MinWidth="520" />
                <ColumnDefinition Width="6" />
                <ColumnDefinition x:Name="RightPaneColumn" Width="3*" MinWidth="300" />
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource CardBorderStyle}" Margin="4,0,4,4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <TextBox Grid.Row="0" Text="{Binding Param.VariableSearchText, UpdateSourceTrigger=PropertyChanged}" />

                    <DataGrid Grid.Row="1"
                              Margin="0,4,0,0"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserResizeColumns="True"
                              CanUserReorderColumns="True"
                              HeadersVisibility="Column"
                              HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Auto"
                              IsReadOnly="False"
                              ItemsSource="{Binding Param.FilteredParameters}"
                              SelectedItem="{Binding Param.SelectedParameter}">
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Header="Auto" Binding="{Binding AutoRead, Mode=TwoWay}" Width="SizeToHeader" />
                            <DataGridTextColumn Header="Name" Binding="{Binding Name, Mode=TwoWay}" Width="2*" />
                            <DataGridTextColumn Header="Address" Binding="{Binding AddressHex, Mode=TwoWay}" Width="*" />
                            <DataGridTextColumn Header="Type" Binding="{Binding Type}" Width="SizeToCells" />
                            <DataGridTextColumn Header="Read" Binding="{Binding CurrentValue, StringFormat=F6}" Width="*" IsReadOnly="True" />
                            <DataGridTextColumn Header="Write" Binding="{Binding TargetValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat=F6}" Width="*" />
                            <DataGridCheckBoxColumn Header="W" Binding="{Binding Writable, Mode=TwoWay}" Width="SizeToHeader" />
                            <DataGridTextColumn Header="Unit" Binding="{Binding Unit, Mode=TwoWay}" Width="SizeToHeader" />
                            <DataGridTextColumn Header="State" Binding="{Binding State}" Width="SizeToCells" IsReadOnly="True" />
                            <DataGridTextColumn Header="Note" Binding="{Binding Note, Mode=TwoWay}" Width="2*" />
                        </DataGrid.Columns>
                    </DataGrid>

                    <StackPanel Grid.Row="2" Orientation="Vertical">
                        <WrapPanel>
                            <Button Content="Read All" Command="{Binding Param.RefreshAllCommand}" />
                            <Button Content="Read Selected" Command="{Binding Param.RefreshSelectedCommand}" />
                            <Button Content="Read Auto" Command="{Binding Param.RefreshCheckedCommand}" />
                            <Button Content="Write Selected" Command="{Binding Param.WriteSelectedCommand}" />
                        </WrapPanel>
                        <WrapPanel>
                            <Button Content="Toggle Auto Refresh" Command="{Binding Param.ToggleAutoRefreshCommand}" />
                            <TextBox Width="80" Text="{Binding Param.AutoRefreshMs, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock VerticalAlignment="Center" Text="ms" />
                            <TextBlock Margin="8,0,0,0" VerticalAlignment="Center" Foreground="{DynamicResource BrushTextSecondary}" Text="{Binding Param.AutoRefreshStatus}" />
                        </WrapPanel>
                    </StackPanel>
                </Grid>
            </Border>

            <GridSplitter Grid.Column="1"
                          Width="6"
                          Background="{DynamicResource BrushBorder}"
                          HorizontalAlignment="Stretch"
                          ShowsPreview="True" />

            <Border Grid.Column="2" Style="{StaticResource CardBorderStyle}" Margin="0,0,0,4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <scottplot:WpfPlot Grid.Row="0" x:Name="ScopePlot" Margin="0" />

                    <UniformGrid Grid.Row="1" Columns="4" Margin="0,6,0,0">
                        <TextBlock Text="{Binding Scope.SampleRateHz, StringFormat=SampleRate: {0:F1} Hz}" />
                        <TextBlock Text="{Binding Scope.DropRatePercent, StringFormat=Drop: {0:F2}%}" />
                        <TextBlock Text="{Binding Scope.BufferUsagePercent, StringFormat=Buffer: {0:F1}%}" />
                        <TextBlock Text="{Binding Scope.LatencyMs, StringFormat=Latency: {0:F2} ms}" />
                    </UniformGrid>
                </Grid>
            </Border>

            <GridSplitter Grid.Column="3"
                          Width="6"
                          Background="{DynamicResource BrushBorder}"
                          HorizontalAlignment="Stretch"
                          ShowsPreview="True" />

            <Border Grid.Column="4" Style="{StaticResource CardBorderStyle}" Margin="4,0,0,4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" FontSize="15" FontWeight="SemiBold" Text="Scope Controls" />
                    <WrapPanel Grid.Row="1">
                        <Button Content="Run" Command="{Binding Scope.StartCommand}" />
                        <Button Content="Stop" Command="{Binding Scope.StopCommand}" />
                        <Button Content="Refresh Layout" Command="{Binding Scope.RefreshLayoutCommand}" />
                    </WrapPanel>

                    <TextBlock Grid.Row="2" FontSize="15" FontWeight="SemiBold" Margin="0,8,0,0" Text="Connection" />
                    <StackPanel Grid.Row="3">
                        <ComboBox ItemsSource="{Binding Connection.Ports}" SelectedItem="{Binding Connection.SelectedPort}" />
                        <ComboBox ItemsSource="{Binding Connection.BaudRates}" SelectedItem="{Binding Connection.SelectedBaudRate}" />
                        <WrapPanel>
                            <Button Content="Refresh" Command="{Binding Connection.RefreshPortsCommand}" />
                            <Button Content="Connect" Command="{Binding Connection.ConnectCommand}" />
                            <Button Content="Disconnect" Command="{Binding Connection.DisconnectCommand}" />
                        </WrapPanel>

                        <TextBlock Margin="0,8,0,0" FontSize="15" FontWeight="SemiBold" Text="CCRX MAP" />
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding Param.ArtifactMapPath}" />
                            <Button Grid.Column="1" Content="MAP..." Command="{Binding Param.BrowseMapPathCommand}" />
                        </Grid>
                        <TextBlock Foreground="{DynamicResource BrushTextSecondary}" Text="{Binding Param.MapImportStatus}" TextWrapping="Wrap" />

                        <TextBlock Margin="0,8,0,0" FontSize="15" FontWeight="SemiBold" Text="Commands" />
                        <UniformGrid Columns="2">
                            <Button Content="RUN" Command="{Binding Param.StartMotorCommand}" />
                            <Button Content="STOP" Command="{Binding Param.StopMotorCommand}" />
                            <Button Content="RESET" Command="{Binding Param.ClearFaultCommand}" />
                            <Button Content="Switch" Command="{Binding Param.SwitchModeCommand}" />
                        </UniformGrid>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <GridSplitter Grid.Row="3"
                      Height="6"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Stretch"
                      Background="{DynamicResource BrushBorder}"
                      ShowsPreview="True" />

        <Border Grid.Row="4" Style="{StaticResource CardBorderStyle}" Margin="4,0,4,4" Padding="4">
            <TabControl>
                <TabItem Header="System Log">
                    <ListView ItemsSource="{Binding Logs}">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Width="170" Header="Time" DisplayMemberBinding="{Binding Timestamp}" />
                                <GridViewColumn Width="120" Header="Category" DisplayMemberBinding="{Binding Category}" />
                                <GridViewColumn Width="1100" Header="Message" DisplayMemberBinding="{Binding Message}" />
                            </GridView>
                        </ListView.View>
                    </ListView>
                </TabItem>
                <TabItem Header="Fault Timeline">
                    <ListView ItemsSource="{Binding Fault.FaultTimeline}">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Width="170" Header="Time" DisplayMemberBinding="{Binding Timestamp}" />
                                <GridViewColumn Width="90" Header="Severity" DisplayMemberBinding="{Binding Severity}" />
                                <GridViewColumn Width="120" Header="Code" DisplayMemberBinding="{Binding Code}" />
                                <GridViewColumn Width="240" Header="Message" DisplayMemberBinding="{Binding Message}" />
                                <GridViewColumn Width="520" Header="Context" DisplayMemberBinding="{Binding Context}" />
                            </GridView>
                        </ListView.View>
                    </ListView>
                </TabItem>
            </TabControl>
        </Border>
    </Grid>
</Window>
